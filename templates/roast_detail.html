{% extends "base.html" %}

{% block title %}{{ roast_session.name }} - Coffee Roaster Logger{% endblock %}

{% block content %}
<div class="px-2 sm:px-0">
    <!-- Header Section -->
    <div class="bg-white shadow rounded-lg p-4 mb-4">
        <div class="flex justify-between items-center">
            <div>
                <h2 class="text-xl font-bold text-gray-900">{{ roast_session.name }}</h2>
                <p class="text-gray-600 text-sm">
                    Started: {{ roast_session.start_time | replace('T', ' ') | replace('.', ' ') | truncate(19, True, '') }}
                    {% if roast_session.end_time %}
                        | Ended: {{ roast_session.end_time | replace('T', ' ') | replace('.', ' ') | truncate(19, True, '') }}
                    {% endif %}
                </p>
            </div>
            
            <div class="flex items-center space-x-3">
                {% if roast_session.status == 'active' %}
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
                        <i class="fas fa-circle mr-1 text-red-600 animate-pulse"></i>
                        Live Recording
                    </span>
                    <button id="stopRoastBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 text-sm rounded font-medium transition-colors">
                        <i class="fas fa-stop mr-1"></i>
                        Stop Roast
                    </button>
                {% else %}
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        <i class="fas fa-check mr-1"></i>
                        Completed
                    </span>
                {% endif %}
                <a href="/" class="text-blue-600 hover:text-blue-900 text-sm font-medium">
                    <i class="fas fa-arrow-left mr-1"></i>
                    Back
                </a>
            </div>
        </div>
    </div>

    <!-- Statistics -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-3">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-thermometer-half text-lg text-red-500"></i>
                    </div>
                    <div class="ml-3 w-0 flex-1">
                        <dl>
                            <dt class="text-xs font-medium text-gray-500 truncate">Peak Temperature</dt>
                            <dd class="text-sm font-medium text-gray-900" id="peakTemp">-</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-3">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-tint text-lg text-blue-500"></i>
                    </div>
                    <div class="ml-3 w-0 flex-1">
                        <dl>
                            <dt class="text-xs font-medium text-gray-500 truncate">Avg Humidity</dt>
                            <dd class="text-sm font-medium text-gray-900" id="avgHumidity">-</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-3">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-clock text-lg text-yellow-500"></i>
                    </div>
                    <div class="ml-3 w-0 flex-1">
                        <dl>
                            <dt class="text-xs font-medium text-gray-500 truncate">Duration</dt>
                            <dd class="text-sm font-medium text-gray-900" id="duration">-</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-3">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-database text-lg text-green-500"></i>
                    </div>
                    <div class="ml-3 w-0 flex-1">
                        <dl>
                            <dt class="text-xs font-medium text-gray-500 truncate">Data Points</dt>
                            <dd class="text-sm font-medium text-gray-900" id="dataCount">{{ roast_data | length }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart -->
    <div class="bg-white shadow rounded-lg p-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-base font-medium text-gray-900">Roast Profile</h3>
            <div class="flex items-center space-x-3">
                <div class="flex items-center">
                    <div class="w-2 h-2 bg-red-500 rounded-full mr-1"></div>
                    <span class="text-xs text-gray-600">Temperature (°C)</span>
                </div>
                <div class="flex items-center">
                    <div class="w-2 h-2 bg-blue-500 rounded-full mr-1"></div>
                    <span class="text-xs text-gray-600">Humidity (%)</span>
                </div>
            </div>
        </div>
        
        <div class="relative" style="height: 400px;">
            <canvas id="roastChart"></canvas>
        </div>
    </div>

    <!-- Current Readings (only for active roasts) -->
    {% if roast_session.status == 'active' %}
    <div class="bg-white shadow rounded-lg p-4 mt-4">
        <h3 class="text-base font-medium text-gray-900 mb-3">Current Readings</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="text-center">
                <div class="text-2xl font-bold text-red-600" id="currentTemp">-</div>
                <div class="text-xs text-gray-500">Current Temperature</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-blue-600" id="currentHumidity">-</div>
                <div class="text-xs text-gray-500">Current Humidity</div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize Socket.IO connection
const socket = io();

// Chart configuration
const ctx = document.getElementById('roastChart').getContext('2d');
const chart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [],
        datasets: [{
            label: 'Temperature (°C)',
            data: [],
            borderColor: 'rgb(239, 68, 68)',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            tension: 0.1,
            yAxisID: 'y'
        }, {
            label: 'Humidity (%)',
            data: [],
            borderColor: 'rgb(59, 130, 246)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.1,
            yAxisID: 'y1'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            mode: 'index',
            intersect: false,
        },
        scales: {
            x: {
                display: true,
                type: 'linear',
                title: {
                    display: true,
                    text: 'Time (MM:SS)'
                },
                min: 0,
                ticks: {
                    stepSize: 0.5,  // Show ticks every 30 seconds
                    callback: function(value) {
                        const minutes = Math.floor(value);
                        const seconds = Math.floor((value % 1) * 60);
                        return `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    }
                }
            },
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                    display: true,
                    text: 'Temperature (°C)'
                },
                grid: {
                    drawOnChartArea: false,
                },
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                    display: true,
                    text: 'Humidity (%)'
                },
                grid: {
                    drawOnChartArea: false,
                },
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

// Initialize chart with existing data
const roastData = {{ roast_data | tojson }};
const roastId = '{{ roast_session.id }}';
const isActive = {{ 'true' if roast_session.status == 'active' else 'false' }};

// Process and display data
if (roastData.length > 0) {
    const startTime = new Date(roastData[0].timestamp);
    const tempData = [];
    const humidityData = [];
    const labels = [];
    
    let totalTemp = 0;
    let totalHumidity = 0;
    let tempCount = 0;
    let humidityCount = 0;
    let maxTemp = -Infinity;
    
    roastData.forEach((point, index) => {
        const timestamp = new Date(point.timestamp);
        const elapsedMinutes = (timestamp - startTime) / 60000;
        const label = `${Math.floor(elapsedMinutes)}:${String(Math.floor((elapsedMinutes % 1) * 60)).padStart(2, '0')}`;
        
        // Debug logging for first few points
        if (index < 5) {
            console.log(`Point ${index}: ${point.timestamp} -> ${timestamp.toISOString()} -> ${elapsedMinutes} min`);
        }
        
        if (point.metric_type === 'temperature') {
            tempData.push({x: elapsedMinutes, y: point.value});
            totalTemp += point.value;
            tempCount++;
            maxTemp = Math.max(maxTemp, point.value);
        } else if (point.metric_type === 'humidity') {
            humidityData.push({x: elapsedMinutes, y: point.value});
            totalHumidity += point.value;
            humidityCount++;
        }
    });
    
    // Debug: Log chart data
    console.log('Temperature data points:', tempData.slice(0, 5));
    console.log('Humidity data points:', humidityData.slice(0, 5));
    
    // Update chart
    chart.data.datasets[0].data = tempData;
    chart.data.datasets[1].data = humidityData;
    chart.update();
    
    // Update statistics
    document.getElementById('peakTemp').textContent = maxTemp > -Infinity ? `${maxTemp.toFixed(1)}°C` : '-';
    document.getElementById('avgHumidity').textContent = humidityCount > 0 ? `${(totalHumidity / humidityCount).toFixed(1)}%` : '-';
    
    // Calculate duration
    const endTime = new Date('{{ roast_session.end_time }}' || new Date());
    const duration = (endTime - startTime) / 1000;
    const minutes = Math.floor(duration / 60);
    const seconds = Math.floor(duration % 60);
    document.getElementById('duration').textContent = `${minutes}m ${seconds}s`;
}

// Socket.IO event handlers for live updates
let roastStartTime = roastData[0] ? new Date(roastData[0].timestamp) : null;

console.log('Roast detail page loaded for roast:', roastId, 'Active:', isActive);

// Global sensor data listener
socket.on('sensor_data', (data) => {
    console.log('🟢 CHART received sensor data:', data);
    
    if (data.roast_id === roastId) {
        const timestamp = new Date(data.timestamp);
        
        // Set start time if not already set
        if (!roastStartTime) {
            roastStartTime = timestamp;
            console.log('Set roast start time:', roastStartTime);
        }
        
        const elapsedMinutes = (timestamp - roastStartTime) / 60000;
        console.log('Elapsed minutes:', elapsedMinutes);
        
        if (data.metric_type === 'temperature') {
            chart.data.datasets[0].data.push({x: elapsedMinutes, y: data.value});
            const currentTempElement = document.getElementById('currentTemp');
            if (currentTempElement) {
                currentTempElement.textContent = `${data.value.toFixed(1)}°C`;
            }
            
            // Update peak temperature
            const peakTempElement = document.getElementById('peakTemp');
            if (peakTempElement) {
                const currentPeak = parseFloat(peakTempElement.textContent) || 0;
                if (data.value > currentPeak) {
                    peakTempElement.textContent = `${data.value.toFixed(1)}°C`;
                }
            }
        } else if (data.metric_type === 'humidity') {
            chart.data.datasets[1].data.push({x: elapsedMinutes, y: data.value});
            const currentHumidityElement = document.getElementById('currentHumidity');
            if (currentHumidityElement) {
                currentHumidityElement.textContent = `${data.value.toFixed(1)}%`;
            }
            
            // Update average humidity
            const humidityData = chart.data.datasets[1].data;
            if (humidityData.length > 0) {
                const avgHumidity = humidityData.reduce((sum, point) => sum + point.y, 0) / humidityData.length;
                const avgHumidityElement = document.getElementById('avgHumidity');
                if (avgHumidityElement) {
                    avgHumidityElement.textContent = `${avgHumidity.toFixed(1)}%`;
                }
            }
        }
        
        // Update data count
        const dataCountElement = document.getElementById('dataCount');
        if (dataCountElement) {
            const currentCount = parseInt(dataCountElement.textContent) || 0;
            dataCountElement.textContent = currentCount + 1;
        }
        
        // Update duration
        const duration = (timestamp - roastStartTime) / 1000;
        const minutes = Math.floor(duration / 60);
        const seconds = Math.floor(duration % 60);
        const durationElement = document.getElementById('duration');
        if (durationElement) {
            durationElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Update chart
        chart.update('none'); // Use 'none' for better performance
        
        // Auto-scale the x-axis to show recent data
        if (chart.data.datasets[0].data.length > 0 || chart.data.datasets[1].data.length > 0) {
            const allData = [...chart.data.datasets[0].data, ...chart.data.datasets[1].data];
            if (allData.length > 0) {
                const maxTime = Math.max(...allData.map(p => p.x));
                if (maxTime > 10) { // If more than 10 minutes, show last 10 minutes
                    chart.options.scales.x.min = Math.max(0, maxTime - 10);
                    chart.options.scales.x.max = maxTime + 1;
                    chart.update('none');
                }
            }
        }
        
        console.log('Updated chart with new data point');
    }
});

// Handle stop roast
const stopRoastBtn = document.getElementById('stopRoastBtn');
if (stopRoastBtn) {
    stopRoastBtn.addEventListener('click', async () => {
        try {
            const response = await fetch(`/api/roasts/${roastId}/stop`, {
                method: 'PUT'
            });
            
            if (response.ok) {
                location.reload();
            } else {
                const error = await response.json();
                alert('Error stopping roast: ' + error.error);
            }
        } catch (error) {
            alert('Error stopping roast: ' + error.message);
        }
    });
}

socket.on('roast_stopped', (data) => {
    if (data.roast_id === roastId) {
        setTimeout(() => location.reload(), 1000);
    }
});
</script>
{% endblock %}