{% extends "base.html" %}

{% block title %}{{ roast_session.name }} - Coffee Roaster Logger{% endblock %}

{% block content %}
<div class="px-2 sm:px-0">
    <!-- Header Section -->
    <div class="{% if roast_session.status == 'active' %}glass-card glow-red border-l-4 border-red-500{% else %}glass-card glow-amber{% endif %} rounded-xl p-6 mb-6">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center">
                {% if roast_session.status == 'active' %}
                    <i class="fas fa-fire text-red-400 animate-pulse mr-3 text-xl"></i>
                    <h2 class="text-2xl font-bold text-red-400">{{ roast_session.name }}</h2>
                {% else %}
                    <i class="fas fa-check text-green-400 mr-3 text-xl"></i>
                    <h2 class="text-2xl font-bold text-amber-300">{{ roast_session.name }}</h2>
                {% endif %}
            </div>
            
            <div class="flex items-center space-x-3">
                {% if roast_session.status == 'active' %}
                    <button id="stopRoastBtn" class="bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white px-6 py-3 text-sm rounded-lg font-semibold transition-all duration-300 shadow-lg glow-red">
                        <i class="fas fa-stop mr-2"></i>
                        Stop Roast
                    </button>
                {% endif %}
                <a href="/" class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-6 py-3 text-sm rounded-lg font-semibold transition-all duration-300 shadow-lg glow-blue">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Back
                </a>
            </div>
        </div>
        
        <div class="text-sm {% if roast_session.status == 'active' %}text-red-300{% else %}text-gray-300{% endif %} mb-4">
            Started: {{ roast_session.start_time | replace('T', ' ') | replace('.', ' ') | truncate(19, True, '') }}
            {% if roast_session.end_time %}
                | Ended: {{ roast_session.end_time | replace('T', ' ') | replace('.', ' ') | truncate(19, True, '') }}
            {% endif %}
        </div>
        
        <!-- Metrics Banner -->
        <div class="grid grid-cols-2 md:grid-cols-8 gap-4">
            <div class="glass-card rounded-lg p-4 border border-amber-400">
                <div class="text-sm text-amber-300">Duration</div>
                <div class="text-2xl font-bold text-amber-400" id="duration">-</div>
            </div>
            {% if roast_session.status == 'active' %}
            <div class="glass-card rounded-lg p-4 border border-red-400">
                <div class="flex items-center justify-between mb-1">
                    <div class="text-sm text-red-300">Current Temp</div>
                    <div class="w-3 h-3 rounded-full bg-green-500" id="tempStatusLight"></div>
                </div>
                <div class="text-2xl font-bold text-red-400" id="currentTemp">-</div>
            </div>
            <div class="glass-card rounded-lg p-4 border border-blue-400">
                <div class="text-sm text-blue-300">Current Humidity</div>
                <div class="text-2xl font-bold text-blue-400" id="currentHumidity">-</div>
            </div>
            {% else %}
            <div class="glass-card rounded-lg p-4 border border-gray-600">
                <div class="text-sm text-gray-300">Current Temp</div>
                <div class="text-2xl font-bold text-gray-400">-</div>
            </div>
            <div class="glass-card rounded-lg p-4 border border-gray-600">
                <div class="text-sm text-gray-300">Current Humidity</div>
                <div class="text-2xl font-bold text-gray-400">-</div>
            </div>
            {% endif %}
            {% if roast_session.status == 'active' %}
            <div class="glass-card rounded-lg p-4 border border-purple-400">
                <div class="text-sm text-purple-300">Current CO2</div>
                <div class="text-2xl font-bold text-purple-400" id="currentCO2">-</div>
            </div>
            <div class="glass-card rounded-lg p-4 border border-orange-400">
                <div class="text-sm text-orange-300">Current VOC</div>
                <div class="text-2xl font-bold text-orange-400" id="currentVOC">-</div>
            </div>
            {% else %}
            <div class="glass-card rounded-lg p-4 border border-gray-600">
                <div class="text-sm text-gray-300">Current CO2</div>
                <div class="text-2xl font-bold text-gray-400">-</div>
            </div>
            <div class="glass-card rounded-lg p-4 border border-gray-600">
                <div class="text-sm text-gray-300">Current VOC</div>
                <div class="text-2xl font-bold text-gray-400">-</div>
            </div>
            {% endif %}
            <div class="glass-card rounded-lg p-4 border border-red-400">
                <div class="text-sm text-red-300">Peak Temp</div>
                <div class="text-2xl font-bold text-red-400" id="peakTemp">-</div>
            </div>
            <div class="glass-card rounded-lg p-4 border border-blue-400">
                <div class="text-sm text-blue-300">Avg Humidity</div>
                <div class="text-2xl font-bold text-blue-400" id="avgHumidity">-</div>
            </div>
            <div class="glass-card rounded-lg p-4 border border-green-400">
                <div class="text-sm text-green-300">Data Points</div>
                <div class="text-2xl font-bold text-green-400" id="dataCount">{{ roast_data | length }}</div>
            </div>
        </div>
    </div>

    <!-- Chart -->
    <div class="glass-card rounded-xl p-6 glow-amber">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-amber-300">
                <i class="fas fa-chart-line mr-2"></i>
                Roast Profile
            </h3>
            <div class="flex items-center space-x-4 flex-wrap">
                <div class="flex items-center">
                    <input type="checkbox" id="toggleTemp" class="mr-1" checked>
                    <div class="w-3 h-3 bg-green-500 rounded-full mr-2" id="tempLegendColor"></div>
                    <span class="text-sm text-green-300 cursor-pointer" id="tempLegendText" onclick="document.getElementById('toggleTemp').click()">Temperature (Â°C)</span>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="toggleHumidity" class="mr-1" checked>
                    <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                    <span class="text-sm text-blue-300 cursor-pointer" onclick="document.getElementById('toggleHumidity').click()">Humidity (%)</span>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="toggleCO2" class="mr-1" checked>
                    <div class="w-3 h-3 bg-purple-500 rounded-full mr-2"></div>
                    <span class="text-sm text-purple-300 cursor-pointer" onclick="document.getElementById('toggleCO2').click()">CO2 (ppm)</span>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="toggleVOC" class="mr-1" checked>
                    <div class="w-3 h-3 bg-orange-500 rounded-full mr-2"></div>
                    <span class="text-sm text-orange-300 cursor-pointer" onclick="document.getElementById('toggleVOC').click()">VOC (ppb)</span>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="toggleComputed" class="mr-1" checked>
                    <div class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></div>
                    <span class="text-sm text-yellow-300 cursor-pointer" onclick="document.getElementById('toggleComputed').click()">Abs Humidity (g/mÂ³)</span>
                </div>
            </div>
        </div>
        
        <div class="relative" style="height: 400px;">
            <canvas id="roastChart"></canvas>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize Socket.IO connection
const socket = io();

// Chart configuration
const ctx = document.getElementById('roastChart').getContext('2d');
const chart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [],
        datasets: [{
            label: 'Temperature (Â°C)',
            data: [],
            borderColor: 'rgb(34, 197, 94)',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            tension: 0.1,
            yAxisID: 'y',
            pointRadius: 0,
            pointHoverRadius: 3
        }, {
            label: 'Humidity (%)',
            data: [],
            borderColor: 'rgb(59, 130, 246)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.1,
            yAxisID: 'y1',
            pointRadius: 0,
            pointHoverRadius: 3
        }, {
            label: 'CO2 (ppm)',
            data: [],
            borderColor: 'rgb(147, 51, 234)',
            backgroundColor: 'rgba(147, 51, 234, 0.1)',
            tension: 0.1,
            yAxisID: 'y2',
            pointRadius: 0,
            pointHoverRadius: 3
        }, {
            label: 'VOC (ppb)',
            data: [],
            borderColor: 'rgb(249, 115, 22)',
            backgroundColor: 'rgba(249, 115, 22, 0.1)',
            tension: 0.1,
            yAxisID: 'y3',
            pointRadius: 0,
            pointHoverRadius: 3
        }, {
            label: 'Abs Humidity (g/mÂ³)',
            data: [],
            borderColor: 'rgb(234, 179, 8)',
            backgroundColor: 'rgba(234, 179, 8, 0.1)',
            tension: 0.1,
            yAxisID: 'y4',
            pointRadius: 0,
            pointHoverRadius: 3
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            mode: 'index',
            intersect: false,
        },
        scales: {
            x: {
                display: true,
                type: 'linear',
                title: {
                    display: true,
                    text: 'Time (MM:SS)'
                },
                min: 0,
                ticks: {
                    stepSize: 0.5,  // Show ticks every 30 seconds
                    callback: function(value) {
                        const minutes = Math.floor(value);
                        const seconds = Math.floor((value % 1) * 60);
                        return `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    }
                }
            },
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                    display: true,
                    text: 'Temperature (Â°C)'
                },
                grid: {
                    drawOnChartArea: false,
                },
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                    display: true,
                    text: 'Humidity (%)'
                },
                grid: {
                    drawOnChartArea: false,
                },
            },
            y2: {
                type: 'linear',
                display: false,
                position: 'left',
                title: {
                    display: false,
                    text: 'CO2 (ppm)'
                },
                grid: {
                    drawOnChartArea: false,
                },
            },
            y3: {
                type: 'linear',
                display: false,
                position: 'right',
                title: {
                    display: false,
                    text: 'VOC (ppb)'
                },
                grid: {
                    drawOnChartArea: false,
                },
            },
            y4: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                    display: true,
                    text: 'Abs Humidity (g/mÂ³)'
                },
                grid: {
                    drawOnChartArea: false,
                },
                offset: true
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

// Initialize chart with existing data
const roastData = {{ roast_data | tojson }};
const roastId = '{{ roast_session.id }}';
const isActive = {{ 'true' if roast_session.status == 'active' else 'false' }};

// Process and display data
console.log('Total roast data points received:', roastData.length);
console.log('Data point types:', roastData.map(p => p.metric_type).filter((v, i, a) => a.indexOf(v) === i));

if (roastData.length > 0) {
    const startTime = new Date(roastData[0].timestamp);
    const tempData = [];
    const humidityData = [];
    const co2Data = [];
    const vocData = [];
    const computedData = [];
    const labels = [];
    
    let totalTemp = 0;
    let totalHumidity = 0;
    let totalCO2 = 0;
    let totalVOC = 0;
    let tempCount = 0;
    let humidityCount = 0;
    let co2Count = 0;
    let vocCount = 0;
    let maxTemp = -Infinity;
    let maxCO2 = -Infinity;
    let maxVOC = -Infinity;
    
    roastData.forEach((point, index) => {
        const timestamp = new Date(point.timestamp);
        const elapsedMinutes = (timestamp - startTime) / 60000;
        const label = `${Math.floor(elapsedMinutes)}:${String(Math.floor((elapsedMinutes % 1) * 60)).padStart(2, '0')}`;
        
        // Debug logging for first few points
        if (index < 5) {
            console.log(`Point ${index}: ${point.timestamp} -> ${timestamp.toISOString()} -> ${elapsedMinutes} min`);
        }
        
        if (point.metric_type === 'temperature') {
            tempData.push({x: elapsedMinutes, y: point.value});
            totalTemp += point.value;
            tempCount++;
            maxTemp = Math.max(maxTemp, point.value);
        } else if (point.metric_type === 'humidity') {
            humidityData.push({x: elapsedMinutes, y: point.value});
            totalHumidity += point.value;
            humidityCount++;
        } else if (point.metric_type === 'co2') {
            co2Data.push({x: elapsedMinutes, y: point.value});
            totalCO2 += point.value;
            co2Count++;
            maxCO2 = Math.max(maxCO2, point.value);
        } else if (point.metric_type === 'voc') {
            vocData.push({x: elapsedMinutes, y: point.value});
            totalVOC += point.value;
            vocCount++;
            maxVOC = Math.max(maxVOC, point.value);
        } else if (point.metric_type === 'computed') {
            computedData.push({x: elapsedMinutes, y: point.value});
        }
    });
    
    // Debug: Log chart data
    console.log('Temperature data points:', tempData.slice(0, 5));
    console.log('Humidity data points:', humidityData.slice(0, 5));
    console.log('CO2 data points:', co2Data.slice(0, 5));
    console.log('VOC data points:', vocData.slice(0, 5));
    console.log('Computed data points:', computedData.slice(0, 5));
    
    // Update chart
    chart.data.datasets[0].data = tempData;
    chart.data.datasets[1].data = humidityData;
    chart.data.datasets[2].data = co2Data;
    chart.data.datasets[3].data = vocData;
    chart.data.datasets[4].data = computedData;
    chart.update();
    
    // Update statistics
    document.getElementById('peakTemp').textContent = maxTemp > -Infinity ? `${maxTemp.toFixed(1)}Â°C` : '-';
    document.getElementById('avgHumidity').textContent = humidityCount > 0 ? `${(totalHumidity / humidityCount).toFixed(1)}%` : '-';
    
    // Calculate duration
    const endTime = new Date('{{ roast_session.end_time }}' || new Date());
    const duration = (endTime - startTime) / 1000;
    const minutes = Math.floor(duration / 60);
    const seconds = Math.floor(duration % 60);
    document.getElementById('duration').textContent = `${minutes}m ${seconds}s`;
}

// Socket.IO event handlers for live updates
let roastStartTime = roastData[0] ? new Date(roastData[0].timestamp) : null;

console.log('Roast detail page loaded for roast:', roastId, 'Active:', isActive);

// Polling for live data updates (1 second interval)
let lastUpdateTimestamp = '';

// Function to update temperature status light
function updateTemperatureStatusLight(isAlert) {
    const statusLight = document.getElementById('tempStatusLight');
    if (statusLight) {
        if (isAlert) {
            statusLight.className = 'w-3 h-3 rounded-full bg-red-500 animate-pulse';
        } else {
            statusLight.className = 'w-3 h-3 rounded-full bg-green-500';
        }
    }
}

// Function to update temperature chart color based on alert status
function updateTemperatureChartColor(isAlert) {
    const legendColor = document.getElementById('tempLegendColor');
    const legendText = document.getElementById('tempLegendText');
    
    if (isAlert) {
        chart.data.datasets[0].borderColor = 'rgb(239, 68, 68)';
        chart.data.datasets[0].backgroundColor = 'rgba(239, 68, 68, 0.1)';
        if (legendColor) legendColor.className = 'w-3 h-3 bg-red-500 rounded-full mr-2';
        if (legendText) legendText.className = 'text-sm text-red-300';
    } else {
        chart.data.datasets[0].borderColor = 'rgb(34, 197, 94)';
        chart.data.datasets[0].backgroundColor = 'rgba(34, 197, 94, 0.1)';
        if (legendColor) legendColor.className = 'w-3 h-3 bg-green-500 rounded-full mr-2';
        if (legendText) legendText.className = 'text-sm text-green-300';
    }
}

async function pollForLiveData() {
    if (!isActive) return;
    
    try {
        const response = await fetch(`/api/roasts/${roastId}/live-data?since=${lastUpdateTimestamp}`);
        const result = await response.json();
        
        if (result.data && result.data.length > 0) {
            console.log('ðŸŸ¢ CHART received live data:', result.data);
            
            // Process new data points
            result.data.forEach(dataPoint => {
                const timestamp = new Date(dataPoint.timestamp);
                
                // Set start time if not already set
                if (!roastStartTime) {
                    roastStartTime = timestamp;
                    console.log('Set roast start time:', roastStartTime);
                }
                
                const elapsedMinutes = (timestamp - roastStartTime) / 60000;
                
                if (dataPoint.metric_type === 'temperature') {
                    chart.data.datasets[0].data.push({x: elapsedMinutes, y: dataPoint.value});
                    const currentTempElement = document.getElementById('currentTemp');
                    if (currentTempElement) {
                        currentTempElement.textContent = `${dataPoint.value.toFixed(1)}Â°C`;
                    }
                    
                    // Update peak temperature
                    const peakTempElement = document.getElementById('peakTemp');
                    if (peakTempElement) {
                        const currentPeak = parseFloat(peakTempElement.textContent) || 0;
                        if (dataPoint.value > currentPeak) {
                            peakTempElement.textContent = `${dataPoint.value.toFixed(1)}Â°C`;
                        }
                    }
                } else if (dataPoint.metric_type === 'humidity') {
                    chart.data.datasets[1].data.push({x: elapsedMinutes, y: dataPoint.value});
                    const currentHumidityElement = document.getElementById('currentHumidity');
                    if (currentHumidityElement) {
                        currentHumidityElement.textContent = `${dataPoint.value.toFixed(1)}%`;
                    }
                    
                    // Update average humidity
                    const humidityData = chart.data.datasets[1].data;
                    if (humidityData.length > 0) {
                        const avgHumidity = humidityData.reduce((sum, point) => sum + point.y, 0) / humidityData.length;
                        const avgHumidityElement = document.getElementById('avgHumidity');
                        if (avgHumidityElement) {
                            avgHumidityElement.textContent = `${avgHumidity.toFixed(1)}%`;
                        }
                    }
                } else if (dataPoint.metric_type === 'co2') {
                    chart.data.datasets[2].data.push({x: elapsedMinutes, y: dataPoint.value});
                    const currentCO2Element = document.getElementById('currentCO2');
                    if (currentCO2Element) {
                        currentCO2Element.textContent = `${dataPoint.value.toFixed(0)} ppm`;
                    }
                } else if (dataPoint.metric_type === 'voc') {
                    chart.data.datasets[3].data.push({x: elapsedMinutes, y: dataPoint.value});
                    const currentVOCElement = document.getElementById('currentVOC');
                    if (currentVOCElement) {
                        currentVOCElement.textContent = `${dataPoint.value.toFixed(0)} ppb`;
                    }
                } else if (dataPoint.metric_type === 'computed') {
                    chart.data.datasets[4].data.push({x: elapsedMinutes, y: dataPoint.value});
                }
                
                // Update data count
                const dataCountElement = document.getElementById('dataCount');
                if (dataCountElement) {
                    const currentCount = parseInt(dataCountElement.textContent) || 0;
                    dataCountElement.textContent = currentCount + 1;
                }
                
                // Update duration
                const duration = (timestamp - roastStartTime) / 1000;
                const minutes = Math.floor(duration / 60);
                const seconds = Math.floor(duration % 60);
                const durationElement = document.getElementById('duration');
                if (durationElement) {
                    durationElement.textContent = `${minutes}m ${seconds}s`;
                }
            });
            
            // Update chart after processing all data points
            chart.update('none');
            
            // Update temperature status light and chart color
            updateTemperatureStatusLight(result.temperature_alert);
            updateTemperatureChartColor(result.temperature_alert);
            
            // Auto-scale the x-axis to show recent data
            const allData = [
                ...chart.data.datasets[0].data, 
                ...chart.data.datasets[1].data,
                ...chart.data.datasets[2].data,
                ...chart.data.datasets[3].data,
                ...chart.data.datasets[4].data
            ];
            if (allData.length > 0) {
                const maxTime = Math.max(...allData.map(p => p.x));
                if (maxTime > 10) { // If more than 10 minutes, show last 10 minutes
                    chart.options.scales.x.min = Math.max(0, maxTime - 10);
                    chart.options.scales.x.max = maxTime + 1;
                    chart.update('none');
                }
            }
            
            // Update timestamp for next poll
            lastUpdateTimestamp = result.timestamp;
            console.log('Updated chart with new data points');
        }
        
        // Update temperature status light and chart color even if no new data
        if (result.hasOwnProperty('temperature_alert')) {
            updateTemperatureStatusLight(result.temperature_alert);
            updateTemperatureChartColor(result.temperature_alert);
        }
        
        // Stop polling if roast is no longer active
        if (!result.is_active) {
            console.log('Roast no longer active, stopping polling');
            clearInterval(pollingInterval);
            setTimeout(() => location.reload(), 1000);
        }
        
    } catch (error) {
        console.error('Error polling for live data:', error);
    }
}

// Start polling if roast is active
let pollingInterval;
if (isActive) {
    console.log('Starting live data polling for roast:', roastId);
    
    // Fetch UI configuration for refresh rate
    fetch('/api/config')
        .then(response => response.json())
        .then(config => {
            const refreshRate = config.ui?.CHART_REFRESH_RATE_MS || 2000;
            console.log('Using chart refresh rate:', refreshRate, 'ms');
            pollingInterval = setInterval(pollForLiveData, refreshRate);
        })
        .catch(error => {
            console.error('Error fetching config, using default refresh rate:', error);
            pollingInterval = setInterval(pollForLiveData, 2000); // Default fallback
        });
}

// Handle stop roast
const stopRoastBtn = document.getElementById('stopRoastBtn');
if (stopRoastBtn) {
    stopRoastBtn.addEventListener('click', async () => {
        try {
            const response = await fetch(`/api/roasts/${roastId}/stop`, {
                method: 'PUT'
            });
            
            if (response.ok) {
                location.reload();
            } else {
                const error = await response.json();
                alert('Error stopping roast: ' + error.error);
            }
        } catch (error) {
            alert('Error stopping roast: ' + error.message);
        }
    });
}

socket.on('roast_stopped', (data) => {
    if (data.roast_id === roastId) {
        setTimeout(() => location.reload(), 1000);
    }
});

// Toggle functionality for chart datasets
function setupToggleControls() {
    const toggles = [
        { id: 'toggleTemp', dataset: 0, axis: 'y' },
        { id: 'toggleHumidity', dataset: 1, axis: 'y1' },
        { id: 'toggleCO2', dataset: 2, axis: 'y2' },
        { id: 'toggleVOC', dataset: 3, axis: 'y3' },
        { id: 'toggleComputed', dataset: 4, axis: 'y4' }
    ];
    
    toggles.forEach(toggle => {
        const checkbox = document.getElementById(toggle.id);
        if (checkbox) {
            checkbox.addEventListener('change', function() {
                const dataset = chart.data.datasets[toggle.dataset];
                const axis = chart.options.scales[toggle.axis];
                
                if (this.checked) {
                    dataset.hidden = false;
                    if (toggle.axis === 'y' || toggle.axis === 'y1' || toggle.axis === 'y4') {
                        axis.display = true;
                    }
                } else {
                    dataset.hidden = true;
                    // Only hide axis if it's not a primary axis (y, y1, y4 are visible by default)
                    if (toggle.axis === 'y2' || toggle.axis === 'y3') {
                        axis.display = false;
                    }
                }
                chart.update();
            });
        }
    });
}

// Initialize toggle controls after chart is created
setupToggleControls();
</script>
{% endblock %}