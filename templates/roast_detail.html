{% extends "base.html" %}

{% block title %}{{ roast_session.name }} - Coffee Roaster Logger{% endblock %}

{% block content %}
<div class="px-2 sm:px-0">
    <!-- Header Section -->
    <div class="{% if roast_session.status == 'active' %}glass-card glow-red border-l-4 border-red-500{% else %}glass-card glow-amber{% endif %} rounded-xl p-6 mb-6">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center">
                {% if roast_session.status == 'active' %}
                    <i class="fas fa-fire text-red-400 animate-pulse mr-3 text-xl"></i>
                    <h2 class="text-2xl font-bold text-red-400">{{ roast_session.name }}</h2>
                {% else %}
                    <i class="fas fa-check text-green-400 mr-3 text-xl"></i>
                    <h2 class="text-2xl font-bold text-amber-300">{{ roast_session.name }}</h2>
                {% endif %}
            </div>
            
            <div class="flex items-center space-x-3">
                {% if roast_session.status == 'active' %}
                    <button id="stopRoastBtn" class="bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white px-6 py-3 text-sm rounded-lg font-semibold transition-all duration-300 shadow-lg glow-red">
                        <i class="fas fa-stop mr-2"></i>
                        Stop Roast
                    </button>
                {% endif %}
                <a href="/" class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-6 py-3 text-sm rounded-lg font-semibold transition-all duration-300 shadow-lg glow-blue">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Back
                </a>
            </div>
        </div>
        
        <div class="text-sm {% if roast_session.status == 'active' %}text-red-300{% else %}text-gray-300{% endif %} mb-4">
            Started: {{ roast_session.start_time | replace('T', ' ') | replace('.', ' ') | truncate(19, True, '') }}
            {% if roast_session.end_time %}
                | Ended: {{ roast_session.end_time | replace('T', ' ') | replace('.', ' ') | truncate(19, True, '') }}
            {% endif %}
        </div>
        
        <!-- Metrics Banner -->
        <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
            <div class="glass-card rounded-lg p-4 border border-amber-400">
                <div class="text-sm text-amber-300">Duration</div>
                <div class="text-2xl font-bold text-amber-400" id="duration">-</div>
            </div>
            {% if roast_session.status == 'active' %}
            <div class="glass-card rounded-lg p-4 border border-red-400">
                <div class="text-sm text-red-300">Current Temp</div>
                <div class="text-2xl font-bold text-red-400" id="currentTemp">-</div>
            </div>
            <div class="glass-card rounded-lg p-4 border border-blue-400">
                <div class="text-sm text-blue-300">Current Humidity</div>
                <div class="text-2xl font-bold text-blue-400" id="currentHumidity">-</div>
            </div>
            {% else %}
            <div class="glass-card rounded-lg p-4 border border-gray-600">
                <div class="text-sm text-gray-300">Current Temp</div>
                <div class="text-2xl font-bold text-gray-400">-</div>
            </div>
            <div class="glass-card rounded-lg p-4 border border-gray-600">
                <div class="text-sm text-gray-300">Current Humidity</div>
                <div class="text-2xl font-bold text-gray-400">-</div>
            </div>
            {% endif %}
            <div class="glass-card rounded-lg p-4 border border-red-400">
                <div class="text-sm text-red-300">Peak Temp</div>
                <div class="text-2xl font-bold text-red-400" id="peakTemp">-</div>
            </div>
            <div class="glass-card rounded-lg p-4 border border-blue-400">
                <div class="text-sm text-blue-300">Avg Humidity</div>
                <div class="text-2xl font-bold text-blue-400" id="avgHumidity">-</div>
            </div>
            <div class="glass-card rounded-lg p-4 border border-green-400">
                <div class="text-sm text-green-300">Data Points</div>
                <div class="text-2xl font-bold text-green-400" id="dataCount">{{ roast_data | length }}</div>
            </div>
        </div>
    </div>

    <!-- Chart -->
    <div class="glass-card rounded-xl p-6 glow-amber">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-amber-300">
                <i class="fas fa-chart-line mr-2"></i>
                Roast Profile
            </h3>
            <div class="flex items-center space-x-4">
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div>
                    <span class="text-sm text-red-300">Temperature (Â°C)</span>
                </div>
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                    <span class="text-sm text-blue-300">Humidity (%)</span>
                </div>
            </div>
        </div>
        
        <div class="relative" style="height: 400px;">
            <canvas id="roastChart"></canvas>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize Socket.IO connection
const socket = io();

// Chart configuration
const ctx = document.getElementById('roastChart').getContext('2d');
const chart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [],
        datasets: [{
            label: 'Temperature (Â°C)',
            data: [],
            borderColor: 'rgb(239, 68, 68)',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            tension: 0.1,
            yAxisID: 'y',
            pointRadius: 0,
            pointHoverRadius: 3
        }, {
            label: 'Humidity (%)',
            data: [],
            borderColor: 'rgb(59, 130, 246)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.1,
            yAxisID: 'y1',
            pointRadius: 0,
            pointHoverRadius: 3
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            mode: 'index',
            intersect: false,
        },
        scales: {
            x: {
                display: true,
                type: 'linear',
                title: {
                    display: true,
                    text: 'Time (MM:SS)'
                },
                min: 0,
                ticks: {
                    stepSize: 0.5,  // Show ticks every 30 seconds
                    callback: function(value) {
                        const minutes = Math.floor(value);
                        const seconds = Math.floor((value % 1) * 60);
                        return `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    }
                }
            },
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                    display: true,
                    text: 'Temperature (Â°C)'
                },
                grid: {
                    drawOnChartArea: false,
                },
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                    display: true,
                    text: 'Humidity (%)'
                },
                grid: {
                    drawOnChartArea: false,
                },
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

// Initialize chart with existing data
const roastData = {{ roast_data | tojson }};
const roastId = '{{ roast_session.id }}';
const isActive = {{ 'true' if roast_session.status == 'active' else 'false' }};

// Process and display data
if (roastData.length > 0) {
    const startTime = new Date(roastData[0].timestamp);
    const tempData = [];
    const humidityData = [];
    const labels = [];
    
    let totalTemp = 0;
    let totalHumidity = 0;
    let tempCount = 0;
    let humidityCount = 0;
    let maxTemp = -Infinity;
    
    roastData.forEach((point, index) => {
        const timestamp = new Date(point.timestamp);
        const elapsedMinutes = (timestamp - startTime) / 60000;
        const label = `${Math.floor(elapsedMinutes)}:${String(Math.floor((elapsedMinutes % 1) * 60)).padStart(2, '0')}`;
        
        // Debug logging for first few points
        if (index < 5) {
            console.log(`Point ${index}: ${point.timestamp} -> ${timestamp.toISOString()} -> ${elapsedMinutes} min`);
        }
        
        if (point.metric_type === 'temperature') {
            tempData.push({x: elapsedMinutes, y: point.value});
            totalTemp += point.value;
            tempCount++;
            maxTemp = Math.max(maxTemp, point.value);
        } else if (point.metric_type === 'humidity') {
            humidityData.push({x: elapsedMinutes, y: point.value});
            totalHumidity += point.value;
            humidityCount++;
        }
    });
    
    // Debug: Log chart data
    console.log('Temperature data points:', tempData.slice(0, 5));
    console.log('Humidity data points:', humidityData.slice(0, 5));
    
    // Update chart
    chart.data.datasets[0].data = tempData;
    chart.data.datasets[1].data = humidityData;
    chart.update();
    
    // Update statistics
    document.getElementById('peakTemp').textContent = maxTemp > -Infinity ? `${maxTemp.toFixed(1)}Â°C` : '-';
    document.getElementById('avgHumidity').textContent = humidityCount > 0 ? `${(totalHumidity / humidityCount).toFixed(1)}%` : '-';
    
    // Calculate duration
    const endTime = new Date('{{ roast_session.end_time }}' || new Date());
    const duration = (endTime - startTime) / 1000;
    const minutes = Math.floor(duration / 60);
    const seconds = Math.floor(duration % 60);
    document.getElementById('duration').textContent = `${minutes}m ${seconds}s`;
}

// Socket.IO event handlers for live updates
let roastStartTime = roastData[0] ? new Date(roastData[0].timestamp) : null;

console.log('Roast detail page loaded for roast:', roastId, 'Active:', isActive);

// Polling for live data updates (1 second interval)
let lastUpdateTimestamp = '';

async function pollForLiveData() {
    if (!isActive) return;
    
    try {
        const response = await fetch(`/api/roasts/${roastId}/live-data?since=${lastUpdateTimestamp}`);
        const result = await response.json();
        
        if (result.data && result.data.length > 0) {
            console.log('ðŸŸ¢ CHART received live data:', result.data);
            
            // Process new data points
            result.data.forEach(dataPoint => {
                const timestamp = new Date(dataPoint.timestamp);
                
                // Set start time if not already set
                if (!roastStartTime) {
                    roastStartTime = timestamp;
                    console.log('Set roast start time:', roastStartTime);
                }
                
                const elapsedMinutes = (timestamp - roastStartTime) / 60000;
                
                if (dataPoint.metric_type === 'temperature') {
                    chart.data.datasets[0].data.push({x: elapsedMinutes, y: dataPoint.value});
                    const currentTempElement = document.getElementById('currentTemp');
                    if (currentTempElement) {
                        currentTempElement.textContent = `${dataPoint.value.toFixed(1)}Â°C`;
                    }
                    
                    // Update peak temperature
                    const peakTempElement = document.getElementById('peakTemp');
                    if (peakTempElement) {
                        const currentPeak = parseFloat(peakTempElement.textContent) || 0;
                        if (dataPoint.value > currentPeak) {
                            peakTempElement.textContent = `${dataPoint.value.toFixed(1)}Â°C`;
                        }
                    }
                } else if (dataPoint.metric_type === 'humidity') {
                    chart.data.datasets[1].data.push({x: elapsedMinutes, y: dataPoint.value});
                    const currentHumidityElement = document.getElementById('currentHumidity');
                    if (currentHumidityElement) {
                        currentHumidityElement.textContent = `${dataPoint.value.toFixed(1)}%`;
                    }
                    
                    // Update average humidity
                    const humidityData = chart.data.datasets[1].data;
                    if (humidityData.length > 0) {
                        const avgHumidity = humidityData.reduce((sum, point) => sum + point.y, 0) / humidityData.length;
                        const avgHumidityElement = document.getElementById('avgHumidity');
                        if (avgHumidityElement) {
                            avgHumidityElement.textContent = `${avgHumidity.toFixed(1)}%`;
                        }
                    }
                }
                
                // Update data count
                const dataCountElement = document.getElementById('dataCount');
                if (dataCountElement) {
                    const currentCount = parseInt(dataCountElement.textContent) || 0;
                    dataCountElement.textContent = currentCount + 1;
                }
                
                // Update duration
                const duration = (timestamp - roastStartTime) / 1000;
                const minutes = Math.floor(duration / 60);
                const seconds = Math.floor(duration % 60);
                const durationElement = document.getElementById('duration');
                if (durationElement) {
                    durationElement.textContent = `${minutes}m ${seconds}s`;
                }
            });
            
            // Update chart after processing all data points
            chart.update('none');
            
            // Auto-scale the x-axis to show recent data
            if (chart.data.datasets[0].data.length > 0 || chart.data.datasets[1].data.length > 0) {
                const allData = [...chart.data.datasets[0].data, ...chart.data.datasets[1].data];
                if (allData.length > 0) {
                    const maxTime = Math.max(...allData.map(p => p.x));
                    if (maxTime > 10) { // If more than 10 minutes, show last 10 minutes
                        chart.options.scales.x.min = Math.max(0, maxTime - 10);
                        chart.options.scales.x.max = maxTime + 1;
                        chart.update('none');
                    }
                }
            }
            
            // Update timestamp for next poll
            lastUpdateTimestamp = result.timestamp;
            console.log('Updated chart with new data points');
        }
        
        // Stop polling if roast is no longer active
        if (!result.is_active) {
            console.log('Roast no longer active, stopping polling');
            clearInterval(pollingInterval);
            setTimeout(() => location.reload(), 1000);
        }
        
    } catch (error) {
        console.error('Error polling for live data:', error);
    }
}

// Start polling if roast is active
let pollingInterval;
if (isActive) {
    console.log('Starting live data polling for roast:', roastId);
    pollingInterval = setInterval(pollForLiveData, 2000); // Poll every 2 seconds
}

// Handle stop roast
const stopRoastBtn = document.getElementById('stopRoastBtn');
if (stopRoastBtn) {
    stopRoastBtn.addEventListener('click', async () => {
        try {
            const response = await fetch(`/api/roasts/${roastId}/stop`, {
                method: 'PUT'
            });
            
            if (response.ok) {
                location.reload();
            } else {
                const error = await response.json();
                alert('Error stopping roast: ' + error.error);
            }
        } catch (error) {
            alert('Error stopping roast: ' + error.message);
        }
    });
}

socket.on('roast_stopped', (data) => {
    if (data.roast_id === roastId) {
        setTimeout(() => location.reload(), 1000);
    }
});
</script>
{% endblock %}